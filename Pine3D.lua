local a=(...):match("(.-)[^%.]+$")local b=require(a.."betterblittle")local c={}for d=1,16 do c[2^(d-1)]=("0123456789abcdef"):sub(d,d)end;local e=math.pow(10,99)local function f(g,h,i,j)local k=i-g;if k==0 then return e,-e*g end;local l=(j-h)/k;return l,h-l*g end;local m=math.min;local n=math.max;local o=math.floor;local p=math.ceil;local function q(g,h,i,j)local r={x1=g,y1=h,x2=i,y2=j,width=i-g+1,height=j-h+1,screenBuffer={{}},blittleWindow=window.create(term.current(),g,h,i-g+1,j-h+1,false),blittleOn=false,backgroundColor=colors.lightBlue}function r:setBufferSize(s,t,u,v)self.x1=s;self.y1=t;self.x2=u;self.y2=v;self.width=u-s+1;self.height=v-t+1;self.blittleWindow.reposition(self.x1,self.y1,self.width,self.height)self:clear()end;function r:clear()local w=self.screenBuffer;w.c2={}w.depth={}local x=w.c2;local y=w.depth;local z=math.huge;local A=self.width;local B=self.backgroundColor;if self.blittleOn then for C=1,self.height do x[C]={}y[C]={}local D=x[C]local E=y[C]for F=1,A do D[F]=B;E[F]=z end end else local G=c[B]w.c1={}local H=w.c1;w.chars={}local I=w.chars;for C=1,self.height do H[C]={}x[C]={}I[C]={}y[C]={}local J=H[C]local D=x[C]local K=I[C]local E=y[C]for F=1,A do J[F]=G;D[F]=G;K[F]=" "E[F]=z end end end end;function r:clearDepth()local w=self.screenBuffer;w.depth={}local y=w.depth;local z=math.huge;local A=self.width;for C=1,self.height do y[C]={}local E=y[C]for F=1,A do E[F]=z end end end;function r:fastClearNormal()local L=self.backgroundColor;local w=self.screenBuffer;local I=w.chars;local H=w.c1;local x=w.c2;local y=self.screenBuffer.depth;local L=c[L]local z=math.huge;local A=self.width;for C=1,self.height do local K=I[C]local J=H[C]local D=x[C]local E=y[C]for F=1,A do K[F]=" "J[F]=L;D[F]=L;E[F]=z end end end;function r:fastClearBLittle()local L=self.backgroundColor;local x=self.screenBuffer.c2;local y=self.screenBuffer.depth;local z=math.huge;local A=self.width;for C=1,self.height do local D=x[C]local E=y[C]for F=1,A do D[F]=L;E[F]=z end end end;function r:setPixel(F,C,H,x,M)F=math.floor(F+0.5)C=math.floor(C+0.5)if F>=1 and F<=self.width then if C>=1 and C<=self.height then local w=self.screenBuffer;if self.blittleOn then w.c2[C][F]=x or H else w.c1[C][F]=c[H]w.c2[C][F]=c[x or H]w.chars[C][F]=" "end end end end;function r:image(F,C,N,O,P)local w=self.screenBuffer;local A=self.width;if self.blittleOn then local k=(o(F+0.5)-1)*2+(O or 0)local Q=(o(C+0.5)-1)*3+(P or 0)local x=w.c2;for R,S in pairs(N)do local T=R+Q;local D=x[T]if D then for U,V in pairs(S)do if V and V>0 then local W=U+k;if W>=1 and W<=A then D[W]=V end end end end end else local k=o(F+0.5)-1;local Q=o(C+0.5)-1;local H=w.c1;local x=w.c2;local I=w.chars;for R,S in pairs(N)do local T=R+Q;local J=H[T]local D=x[T]local K=I[T]if D then for U,V in pairs(S)do if V and V>0 then local W=U+k;if W>=1 and W<=A then J[U]=c[H]D[U]=c[x or H]K[U]=" "end end end end end end end;function r:loadLineNormal(g,h,i,j,L,M,X,l,Y,y)local w=self.screenBuffer;local H=w.c1;local x=w.c2;local I=w.chars;local Z=w.depth;local _=self.width;local a0=self.height;if i>=g then for F=n(p(g),1),m(o(i),_)do local C=o(l*F+Y+0.5)if C>0 and C<=a0 and y<=Z[C][F]then H[C][F]=X;x[C][F]=L;I[C][F]=M;Z[C][F]=y end end else for F=n(p(i),1),m(o(g),_)do local C=o(l*F+Y+0.5)if C>0 and C<=a0 and y<=Z[C][F]then H[C][F]=X;x[C][F]=L;I[C][F]=M;Z[C][F]=y end end end;if j>=h then for C=n(p(h),1),m(o(j),a0)do local F=o((C-Y)/l+0.5)local a1=Z[C]if F>0 and F<=_ and y<=a1[F]then H[C][F]=X;x[C][F]=L;I[C][F]=M;a1[F]=y end end else for C=n(p(j),1),m(o(h),a0)do local F=o((C-Y)/l+0.5)local a1=Z[C]if F>0 and F<=_ and y<=a1[F]then H[C][F]=X;x[C][F]=L;I[C][F]=M;a1[F]=y end end end end;function r:loadLineBLittle(g,h,i,j,L,l,Y,y)local w=self.screenBuffer;local x=w.c2;local Z=w.depth;local _=self.width;local a0=self.height;if i>=g then for F=n(p(g),1),m(o(i),_)do local C=o(l*F+Y+0.5)if C>0 and C<=a0 and y<=Z[C][F]then x[C][F]=L;Z[C][F]=y end end else for F=n(p(i),1),m(o(g),_)do local C=o(l*F+Y+0.5)if C>0 and C<=a0 and y<=Z[C][F]then x[C][F]=L;Z[C][F]=y end end end;if j>=h then for C=n(p(h),1),m(o(j),a0)do local F=o((C-Y)/l+0.5)local a1=Z[C]if F>0 and F<=_ and y<=a1[F]then x[C][F]=L;a1[F]=y end end else for C=n(p(j),1),m(o(h),a0)do local F=o((C-Y)/l+0.5)local a1=Z[C]if F>0 and F<=_ and y<=a1[F]then x[C][F]=L;a1[F]=y end end end end;local a2=colors.black;function r:drawTriangleNormal(g,h,i,j,a3,a4,L,M,X,a5,y)if g<1 and i<1 and a3<1 or h<1 and j<1 and a4<1 then return end;local _=self.width;if g>_ and i>_ and a3>_ then return end;local a0=self.height;if h>a0 and j>a0 and a4>a0 then return end;if h>j then h,j=j,h;g,i=i,g end;if j>a4 then a4,j=j,a4;a3,i=i,a3 end;if h>j then h,j=j,h;g,i=i,g end;local w=self.screenBuffer;local o,p=o,p;local m,n=m,n;local a6=m(n(1,p(h)),a0)local a7=m(n(0,o(j)),a0)local a8=m(n(1,o(a4)),a0)local H=w.c1;local x=w.c2;local I=w.chars;local Z=w.depth;local a9=(i-g)/(j-h)local aa=(g-a3)/(h-a4)M=M or" "X=X or L;local L=c[L]local X=c[X]if h~=j and h~=a4 then for C=a6,a7 do local J=H[C]local D=x[C]local K=I[C]local E=Z[C]local ab=(C-h)*a9+g;local ac=(C-a4)*aa+a3;if ac<ab then ab,ac=ac,ab end;if ab<1 then ab=1 end;if ab>_ then ab=_+1 end;if ac<1 then ac=0 end;if ac>_ then ac=_ end;for F=o(ab+0.5),o(ac+0.5)do if y<E[F]then E[F]=y;J[F]=X;D[F]=L;K[F]=M end end end end;local ad=(a3-i)/(a4-j)local aa=(g-a3)/(h-a4)if a4~=j and h~=a4 then for C=a7+1,a8 do local J=H[C]local D=x[C]local K=I[C]local E=Z[C]local ab=(C-j)*ad+i;local ac=(C-a4)*aa+a3;if ac<ab then ab,ac=ac,ab end;if ab<1 then ab=1 end;if ab>_ then ab=_+1 end;if ac<1 then ac=0 end;if ac>_ then ac=_ end;for F=o(ab+0.5),o(ac+0.5)do if y<E[F]then E[F]=y;J[F]=X;D[F]=L;K[F]=M end end end end;local a5=a5;if a5 or self.triangleEdges then local ae,af=f(g,h,i,j)local ag,ah=f(i,j,a3,a4)local ai,aj=f(g,h,a3,a4)local ak=self.loadLineNormal;local L=c[a5 or a2]ak(self,g,h,i,j,L,M,X,ae,af,y)ak(self,i,j,a3,a4,L,M,X,ag,ah,y)ak(self,a3,a4,g,h,L,M,X,ai,aj,y)end end;function r:drawTriangleBLittle(g,h,i,j,a3,a4,L,M,X,a5,y)if g<1 and i<1 and a3<1 or h<1 and j<1 and a4<1 then return end;local _=self.width;if g>_ and i>_ and a3>_ then return end;local a0=self.height;if h>a0 and j>a0 and a4>a0 then return end;if h>j then h,j=j,h;g,i=i,g end;if j>a4 then a4,j=j,a4;a3,i=i,a3 end;if h>j then h,j=j,h;g,i=i,g end;local w=self.screenBuffer;local o,p=o,p;local m,n=m,n;local a6=m(n(1,p(h)),a0)local a7=m(n(0,o(j)),a0)local a8=m(n(1,o(a4)),a0)local x=w.c2;local Z=w.depth;local a9=(i-g)/(j-h)local aa=(g-a3)/(h-a4)if h~=j and h~=a4 then for C=a6,a7 do local D=x[C]local E=Z[C]local ab=(C-h)*a9+g;local ac=(C-a4)*aa+a3;if ac<ab then ab,ac=ac,ab end;if ab<1 then ab=1 end;if ab>_ then ab=_+1 end;if ac<1 then ac=0 end;if ac>_ then ac=_ end;for F=o(ab+0.5),o(ac+0.5)do if y<E[F]then E[F]=y;D[F]=L end end end end;local ad=(a3-i)/(a4-j)local aa=(g-a3)/(h-a4)if a4~=j and h~=a4 then for C=a7+1,a8 do local D=x[C]local E=Z[C]local ab=(C-j)*ad+i;local ac=(C-a4)*aa+a3;if ac<ab then ab,ac=ac,ab end;if ab<1 then ab=1 end;if ab>_ then ab=_+1 end;if ac<1 then ac=0 end;if ac>_ then ac=_ end;for F=o(ab+0.5),o(ac+0.5)do if y<E[F]then E[F]=y;D[F]=L end end end end;local a5=a5;if a5 or self.triangleEdges then local ae,af=f(g,h,i,j)local ag,ah=f(i,j,a3,a4)local ai,aj=f(g,h,a3,a4)local ak=self.loadLineBLittle;local L=a5 or a2;ak(self,g,h,i,j,L,ae,af,y)ak(self,i,j,a3,a4,L,ag,ah,y)ak(self,a3,a4,g,h,L,ai,aj,y)end end;function r:drawBufferNormal()local g=self.x1;local h=self.y1;local w=self.screenBuffer;local al=term.setCursorPos;local am=term.blit;local I=w.chars;local H=w.c1;local x=w.c2;local an=table.concat;for C=1,self.height do al(g,C+h-1)local I=an(I[C])local H=an(H[C])local x=an(x[C])am(I,H,x)end end;function r:drawBufferBLittle()local ao=self.blittleWindow;b.drawBuffer(self.screenBuffer.c2,ao)ao.setVisible(true)ao.setVisible(false)end;function r:highResMode(ap)self.blittleOn=ap;self.drawTriangle=ap and self.drawTriangleBLittle or self.drawTriangleNormal;self.fastClear=ap and self.fastClearBLittle or self.fastClearNormal;self.drawBuffer=ap and self.drawBufferBLittle or self.drawBufferNormal;self:clear()end;function r:useTriangleEdges(ap)self.triangleEdges=ap end;r:highResMode(true)return r end;local function aq(ar,as,at,au,av)local aw=av[1]local ax=av[2]local ay=av[3]local az=as and as-aw or 0;local aA=at and at-ax or 0;local aB=au and au-ay or 0;for d=1,#ar do local aC=ar[d]local aD=az+(aC[1]+aC[4]+aC[7])/3;local aE=aA+(aC[2]+aC[5]+aC[8])/3;local aF=aB+(aC[3]+aC[6]+aC[9])/3;aC[16]=aD*aD+aE*aE+aF*aF end end;local aG=math.rad;local aH=math.sin;local aI=math.cos;local function aJ(F,C,aK,aL,aM)local aN=aM*aK-aL*C;local C=aL*aK+aM*C;local aK=aN;return F,C,aK end;local function aO(F,C,aK,aL,aM)local aN=aM*aK-aL*F;local F=aL*aK+aM*F;local aK=aN;return F,C,aK end;local function aP(F,C,aK,aL,aM)local j=aM*C-aL*F;local F=aL*C+aM*F;local C=j;return F,C end;local function aQ(aR,aS,aT,aU)local aV,aW=0,1;local aX,aY=0,1;local aZ,a_=0,1;if aS==0 then aS=nil end;if aS then aV,aW=aH(aS),aI(aS)end;if aT==0 then aT=nil end;if aT then aX,aY=aH(aT),aI(aT)end;if aU==0 then aU=nil end;if aU then aZ,a_=aH(aU),aI(aU)end;local b0={}for b1,aC in pairs(aR)do local g,h,b2=aC[1],aC[2],aC[3]local i,j,aN=aC[4],aC[5],aC[6]local a3,a4,b3=aC[7],aC[8],aC[9]if aT then g,h,b2=aO(g,h,b2,aX,aY)i,j,aN=aO(i,j,aN,aX,aY)a3,a4,b3=aO(a3,a4,b3,aX,aY)end;if aU then g,h=aP(g,h,b2,aZ,a_)i,j=aP(i,j,aN,aZ,a_)a3,a4=aP(a3,a4,b3,aZ,a_)end;if aS then g,h,b2=aJ(g,h,b2,aV,aW)i,j,aN=aJ(i,j,aN,aV,aW)a3,a4,b3=aJ(a3,a4,b3,aV,aW)end;b0[#b0+1]={g,h,b2,i,j,aN,a3,a4,b3}b0[#b0][10]=aC[10]b0[#b0][11]=aC[11]b0[#b0][12]=aC[12]b0[#b0][13]=aC[13]b0[#b0][14]=aC[14]end;return b0 end;local b4={}function b4.invertTriangles(aR)if not aR or type(aR)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for d=1,#aR do local b5=aR[d]aR[d]={x1=b5.x1,y1=b5.y1,z1=b5.z1,x2=b5.x3,y2=b5.y3,z2=b5.z3,x3=b5.x2,y3=b5.y2,z3=b5.z2,c=b5.c,char=b5.char,charc=b5.charc,forceRender=b5.forceRender,outlineColor=b5.outlineColor}end;return aR end;function b4.setOutline(aR,b6)if not aR or type(aR)~="table"then error("transforms.invertTriangles expected arg#1 to be a table (model)")end;for d=1,#aR do local b5=aR[d]if type(b6)=="table"then b5.outlineColor=b6[b5.c]or b5.outlineColor else b5.outlineColor=b6 end end;return aR end;function b4.mapColor(aR,b6)if not aR or type(aR)~="table"then error("transforms.mapColor expected arg#1 to be a table (model)")end;for d=1,#aR do local b5=aR[d]if type(b6)=="table"then b5.c=b6[b5.c]or b5.c else b5.c=b6 end end;return aR end;function b4.center(aR)local b7,b8=math.huge,-math.huge;local a6,a8=math.huge,-math.huge;local b9,ba=math.huge,-math.huge;for d=1,#aR do local bb=aR[d]b7,b8=m(b7,bb.x1),n(b8,bb.x1)b7,b8=m(b7,bb.x2),n(b8,bb.x2)b7,b8=m(b7,bb.x3),n(b8,bb.x3)a6,a8=m(a6,bb.y1),n(a8,bb.y1)a6,a8=m(a6,bb.y2),n(a8,bb.y2)a6,a8=m(a6,bb.y3),n(a8,bb.y3)b9,ba=m(b9,bb.z1),n(ba,bb.z1)b9,ba=m(b9,bb.z2),n(ba,bb.z2)b9,ba=m(b9,bb.z3),n(ba,bb.z3)end;local bc=-(b8+b7)*0.5;local bd=-(a8+a6)*0.5;local be=-(ba+b9)*0.5;for d=1,#aR do local bb=aR[d]bb.x1=bb.x1+bc;bb.x2=bb.x2+bc;bb.x3=bb.x3+bc;bb.y1=bb.y1+bd;bb.y2=bb.y2+bd;bb.y3=bb.y3+bd;bb.z1=bb.z1+be;bb.z2=bb.z2+be;bb.z3=bb.z3+be end;return aR end;function b4.normalizeScale(aR)local bf=-math.huge;for d=1,#aR do local bb=aR[d]bf=n(bf,bb.x1)bf=n(bf,bb.x2)bf=n(bf,bb.x3)bf=n(bf,bb.y1)bf=n(bf,bb.y2)bf=n(bf,bb.y3)bf=n(bf,bb.z1)bf=n(bf,bb.z2)bf=n(bf,bb.z3)end;for d=1,#aR do local bb=aR[d]bb.x1=bb.x1/bf;bb.x2=bb.x2/bf;bb.x3=bb.x3/bf;bb.y1=bb.y1/bf;bb.y2=bb.y2/bf;bb.y3=bb.y3/bf;bb.z1=bb.z1/bf;bb.z2=bb.z2/bf;bb.z3=bb.z3/bf end;return aR end;function b4.normalizeScaleY(aR)local bf=-math.huge;for d=1,#aR do local bb=aR[d]bf=n(bf,bb.y1)bf=n(bf,bb.y2)bf=n(bf,bb.y3)end;for d=1,#aR do local bb=aR[d]bb.x1=bb.x1/bf;bb.x2=bb.x2/bf;bb.x3=bb.x3/bf;bb.y1=bb.y1/bf;bb.y2=bb.y2/bf;bb.y3=bb.y3/bf;bb.z1=bb.z1/bf;bb.z2=bb.z2/bf;bb.z3=bb.z3/bf end;return aR end;function b4.scale(aR,bg)for d=1,#aR do local bb=aR[d]bb.x1=bb.x1*bg;bb.x2=bb.x2*bg;bb.x3=bb.x3*bg;bb.y1=bb.y1*bg;bb.y2=bb.y2*bg;bb.y3=bb.y3*bg;bb.z1=bb.z1*bg;bb.z2=bb.z2*bg;bb.z3=bb.z3*bg end;return aR end;function b4.translate(aR,k,Q,bh)for d=1,#aR do local bb=aR[d]bb.x1=bb.x1+(k or 0)bb.x2=bb.x2+(k or 0)bb.x3=bb.x3+(k or 0)bb.y1=bb.y1+(Q or 0)bb.y2=bb.y2+(Q or 0)bb.y3=bb.y3+(Q or 0)bb.z1=bb.z1+(bh or 0)bb.z2=bb.z2+(bh or 0)bb.z3=bb.z3+(bh or 0)end;return aR end;function b4.rotate(aR,aS,aT,aU)local aV,aW=0,1;local aX,aY=0,1;local aZ,a_=0,1;if aS==0 then aS=nil end;if aS then aV,aW=aH(aS),aI(aS)end;if aT==0 then aT=nil end;if aT then aX,aY=aH(aT),aI(aT)end;if aU==0 then aU=nil end;if aU then aZ,a_=aH(aU),aI(aU)end;for d=1,#aR do local aC=aR[d]local g,h,b2=aC.x1,aC.y1,aC.z1;local i,j,aN=aC.x2,aC.y2,aC.z2;local a3,a4,b3=aC.x3,aC.y3,aC.z3;if aT then g,h,b2=aO(g,h,b2,aX,aY)i,j,aN=aO(i,j,aN,aX,aY)a3,a4,b3=aO(a3,a4,b3,aX,aY)end;if aU then g,h=aP(g,h,b2,aZ,a_)i,j=aP(i,j,aN,aZ,a_)a3,a4=aP(a3,a4,b3,aZ,a_)end;if aS then g,h,b2=aJ(g,h,b2,aV,aW)i,j,aN=aJ(i,j,aN,aV,aW)a3,a4,b3=aJ(a3,a4,b3,aV,aW)end;aC.x1,aC.y1,aC.z1=g,h,b2;aC.x2,aC.y2,aC.z2=i,j,aN;aC.x3,aC.y3,aC.z3=a3,a4,b3 end;return aR end;function b4.alignBottom(aR)local a6=math.huge;for d=1,#aR do local bb=aR[d]a6=m(a6,bb.y1)a6=m(a6,bb.y2)a6=m(a6,bb.y3)end;for d=1,#aR do local bb=aR[d]bb.y1=bb.y1-a6;bb.y2=bb.y2-a6;bb.y3=bb.y3-a6 end;return aR end;function b4.decimate(aR,bi,bj)local bk={}local bl={}local function bm(F,C,aK)for d=#bk,1,-1 do local bn=bk[d]if bn[1]==F and bn[2]==C and bn[3]==aK then return d end end end;for d=1,#aR do local bb=aR[d]local bo=bm(bb.x1,bb.y1,bb.z1)if not bo then bk[#bk+1]={bb.x1,bb.y1,bb.z1}bo=#bk end;local bp=bm(bb.x2,bb.y2,bb.z2)if not bp then bk[#bk+1]={bb.x2,bb.y2,bb.z2}bp=#bk end;local bq=bm(bb.x3,bb.y3,bb.z3)if not bq then bk[#bk+1]={bb.x3,bb.y3,bb.z3}bq=#bk end;local b5={bo,bp,bq,bb.c,bb.char,bb.charc,bb.forceRender}bl[#bl+1]=b5 end;local function br(bs,bt)local k=bs[1]-bt[1]local Q=bs[2]-bt[2]local bh=bs[3]-bt[3]return(k*k+Q*Q+bh*bh)^0.5 end;local bu={}for d=1,#bl do local b5=bl[d]local bv=br(bk[b5[1]],bk[b5[2]])local bw=br(bk[b5[2]],bk[b5[3]])local bx=br(bk[b5[1]],bk[b5[3]])bu[#bu+1]={length=bv,vA=b5[1],vB=b5[2]}bu[#bu+1]={length=bw,vA=b5[2],vB=b5[3]}bu[#bu+1]={length=bx,vA=b5[1],vB=b5[3]}end;local function by(bz,bA)local bB=bk[bz]local bC=bk[bA]local bD={(bB[1]+bC[1])*0.5,(bB[2]+bC[2])*0.5,(bB[3]+bC[3])*0.5}bk[#bk+1]=bD;local bE=#bk;for d=#bl,1,-1 do local bF=bl[d]if bF[1]==bz or bF[1]==bA or bF[2]==bz or bF[2]==bA or bF[3]==bz or bF[3]==bA then if bF[1]==bz or bF[1]==bA then bF[1]=bE end;if bF[2]==bz or bF[2]==bA then bF[2]=bE end;if bF[3]==bz or bF[3]==bA then bF[3]=bE end;if bF[1]==bF[2]or bF[2]==bF[3]or bF[1]==bF[3]then table.remove(bl,d)end end end;return bE end;local bG=bi;if bj~="polys"then bG=#aR*bi end;while#bl>bG do local bH=math.huge;local bI;for d=1,#bu do local bJ=bu[d]if bJ.length<bH then bH=bJ.length;bI=d end end;local bK=bu[bI]local bE=by(bK.vA,bK.vB)for d=#bu,1,-1 do local bJ=bu[d]local bL=bJ.vA==bK.vA or bJ.vA==bK.vB;local bM=bJ.vB==bK.vA or bJ.vB==bK.vB;if bL and bM then table.remove(bu,d)elseif bL then bJ.vA=bE elseif bM then bJ.vB=bE end end end;local bN={}for d=1,#bl do local b5=bl[d]local bs=bk[b5[1]]local bt=bk[b5[2]]local bO=bk[b5[3]]bN[#bN+1]={x1=bs[1],y1=bs[2],z1=bs[3],x2=bt[1],y2=bt[2],z2=bt[3],x3=bO[1],y3=bO[2],z3=bO[3],c=b5[4],char=b5[5],charc=b5[6],forceRender=b5[7]}end;for bP,bQ in pairs(b4)do bN[bP]=bQ end;return bN end;local bR,bS;function b4.toLoD(aR,bT)bT=bT or{}local bU={minQuality=bT.minQuality or 0.1,variantCount=bT.variantCount or 4,qualityHalvingDistance=bT.qualityHalvingDistance or 5,quickInitWorseRuntime=bT.quickInitWorseRuntime or false}local bV,bW=bS(aR)local bX={{quality=1,collapsedModel=bV,size=bW}}local bY=aR;local bZ=#bY;for d=1,bU.variantCount do local bi=(1-bU.minQuality)*(1-d/bU.variantCount)+bU.minQuality;local b_=math.floor(bZ*bi+0.5)local c0=bY:decimate(b_,"polys")local bV,bW=bS(c0)bY=c0;local c1={quality=bi,collapsedModel=bV,size=bW}bX[#bX+1]=c1 end;local function c2(c3)local c4={}for d=1,#c3 do local c1=c3[d]local aR=c1.collapsedModel;local c5={}for c6=1,#aR do local bb=aR[c6]local c7={bb[1],bb[2],bb[3],bb[4],bb[5],bb[6],bb[7],bb[8],bb[9],bb[10],bb[11],bb[12],bb[13],bb[14]}c5[c6]=c7 end;local c8={quality=c1.quality,size=c1.size,collapsedModel=c5}c4[d]=c8 end;return c4 end;local c9={}function bU:initObject(ca)local cb;if bU.quickInitWorseRuntime then cb=bX else cb=c2(bX)end;c9[ca]=cb;ca[7]=cb[1].collapsedModel;ca[8]=cb[1].size;ca[9]=bU end;function bU:update(ca,av)local cb=c9[ca]if cb then local k=av[1]-ca[1]local Q=av[2]-ca[2]local bh=av[3]-ca[3]local cc=(k*k+Q*Q+bh*bh)^0.5;local cd=math.min(1,math.max(bU.minQuality,1/(cc/bU.qualityHalvingDistance)))local ce=bU.variantCount+1-bU.variantCount*(cd-bU.minQuality)/(1-bU.minQuality)local cf=math.floor(ce+0.5)local c1=cb[cf]ca[7]=c1.collapsedModel;ca[8]=c1.size end end;return bU end;local cg=math.sqrt;function bS(aR)local ch={}local ci=0;for d=1,#aR do local aC=aR[d]ch[#ch+1]={}ch[#ch][1]=aC.x1;ch[#ch][2]=aC.y1;ch[#ch][3]=aC.z1;ch[#ch][4]=aC.x2;ch[#ch][5]=aC.y2;ch[#ch][6]=aC.z2;ch[#ch][7]=aC.x3;ch[#ch][8]=aC.y3;ch[#ch][9]=aC.z3;ch[#ch][10]=aC.forceRender;ch[#ch][11]=aC.c;ch[#ch][12]=aC.char;ch[#ch][13]=aC.charc;ch[#ch][14]=aC.outlineColor;local cj=cg(aC.x1*aC.x1+aC.y1*aC.y1+aC.z1*aC.z1)local ck=cg(aC.x2*aC.x2+aC.y2*aC.y2+aC.z2*aC.z2)local cl=cg(aC.x3*aC.x3+aC.y3*aC.y3+aC.z3*aC.z3)if cj>ci then ci=cj end;if ck>ci then ci=ck end;if cl>ci then ci=cl end end;return ch,ci end;function bR(cm)local cn=fs.open(cm,"r")if not cn then error("Could not find model for an object at path: "..cm)end;local co=cn.readAll()cn.close()local aR=textutils.unserialise(co)for bP,bQ in pairs(b4)do aR[bP]=bQ end;return aR end;local cp=math.pi;local aH=math.sin;local aI=math.cos;local cq=math.tan;local cg=math.sqrt;local function cr(g,h,i,j)local A,cs=term.getSize()if g and i then A=i-g+1 end;if h and j then cs=j-h+1 end;local g=g or 1;local h=h or 1;local i=i or A-g+1;local j=j or cs-h+1;local ct={camera={0.000001,0.000001,0.000001,nil,0,0},buffer=q(g,h,i,j),x1=g,y1=h,x2=i,y2=j,width=A,height=cs,blittleOn=false,pixelratio=1.5}ct.FoV=90;ct.camera[7]=aG(ct.FoV)ct.t=cq(aG(ct.FoV/2))*2*0.0001;local cu,cv,cw,cx;function ct:setBackgroundColor(L)local cy=self.buffer;cy.backgroundColor=L;cy:fastClear()end;local function cz()cu=o(ct.width*0.5)+1;cv=o(ct.height*0.5)cw=0.0001*ct.width/ct.t;cx=-0.0001*ct.width/(ct.t*ct.height*ct.pixelratio)*ct.height end;function ct:setSize(g,h,i,j)self.x1=g;self.y1=h;self.x2=i;self.y2=j;if not self.blittleOn then self.buffer:setBufferSize(g,h,i,j)self.width=i-g+1;self.height=j-h+1;self.pixelratio=1.5 else self.width=(i-g+1)*2;self.height=(j-h+1)*3;self.pixelratio=1;self.buffer:setBufferSize(g,h,g+self.width-1,h+self.height-1)end;cz()end;function ct:highResMode(ap)self.blittleOn=ap;self.buffer:highResMode(ap)if ap then self.width=(self.x2-self.x1+1)*2;self.height=(self.y2-self.y1+1)*3;self.buffer:setBufferSize(self.x1,self.y1,self.x1+self.width-1,self.y1+self.height-1)self.pixelratio=1 else self.buffer:setBufferSize(self.x1,self.y1,self.x2,self.y2)self.width=self.x2-self.x1+1;self.height=self.y2-self.y1+1;self.pixelratio=1.5 end;cz()end;function ct:map3dTo2d(F,C,aK)local av=self.camera;local cA=aH(av[4]or 0)local cB=aI(av[4]or 0)local cC=aH(-av[5])local cD=aI(-av[5])local cE=aH(av[6])local cF=aI(av[6])local cG=F-av[1]local cH=C-av[2]local cI=aK-av[3]local cJ=cD*cG-cC*cI;cI=cC*cG+cD*cI;cG=cJ;local cK=cF*cH-cE*cG;cG=cE*cH+cF*cG;cH=cK;if cA~=0 then local cL=cA*cI-cB*cH;cH=cB*cI+cA*cH;cI=cL end;local cM=cI/cG*cw+cu;local cN=cH/cG*cx+cv;return cM,cN,cG>=0.0001 end;function ct:drawObject(ca,av,cO)local cP=ca[1]local cQ=ca[2]local cR=ca[3]local cA=cO[1]local cB=cO[2]local cC=cO[3]local cD=cO[4]local cE=cO[5]local cF=cO[6]local cS=cP and cP-av[1]or 0;local cT=cQ and cQ-av[2]or 0;local cU=cR and cR-av[3]or 0;local bU=ca[9]if bU then bU:update(ca,av)end;local aR=ca[7]if#aR<=0 then return end;local bW=ca[8]local cG=cS;local cH=cT;local cI=cU;local cJ=cD*cG-cC*cI;local cI=cC*cG+cD*cI;local cG=cJ;local cG=cE*cH+cF*cG;if cG<-bW then return end;local cV=0.5*av[7]local cW=aH(cV)local cX=aI(cV)if(cG+bW)*cW+(cI+bW)*cX<0 then return end;if(cG+bW)*cW-(cI-bW)*cX<0 then return end;local aS=ca[4]local aT=ca[5]local aU=ca[6]if aS and aS~=0 or aT and aT~=0 or aU and aU~=0 then aR=aQ(aR,aS,aT,aU)end;aq(aR,cP,cQ,cR,av)local cY=cS*cS+cT*cT+cU*cU<bW*bW*4;local cu=cu;local cv=cv;local cw=cw;local cx=cx;local cA=cA;local cB=cB;local cC=cC;local cD=cD;local cE=cE;local cF=cF;local cS=cS;local cT=cT;local cU=cU;local function cZ(cG,cH,cI)local cJ=cD*cG-cC*cI;cI=cC*cG+cD*cI;cG=cJ;local cK=cF*cH-cE*cG;cG=cE*cH+cF*cG;cH=cK;local cM=cI/cG*cw+cu;local cN=cH/cG*cx+cv;return cM,cN,cG end;if cA~=0 then function cZ(cG,cH,cI)local cJ=cD*cG-cC*cI;cI=cC*cG+cD*cI;cG=cJ;local cK=cF*cH-cE*cG;cG=cE*cH+cF*cG;cH=cK;local cL=cA*cI-cB*cH;cH=cB*cI+cA*cH;cI=cL;local cM=cI/cG*cw+cu;local cN=cH/cG*cx+cv;return cM,cN,cG end end;local c_=aR;local cy=self.buffer;for d=1,#c_ do local aC=c_[d]local y=aC[16]local g,h,d0=cZ(aC[1]+cS,aC[2]+cT,aC[3]+cU)if d0>0.00010000001 then local i,j,cJ=cZ(aC[4]+cS,aC[5]+cT,aC[6]+cU)if cJ>0.00010000001 then local a3,a4,d1=cZ(aC[7]+cS,aC[8]+cT,aC[9]+cU)if d1>0.00010000001 then if aC[10]or(i-g)*(a4-j)-(j-h)*(a3-i)<0 then cy:drawTriangle(g,h,i,j,a3,a4,aC[11],aC[12],aC[13],aC[14],y)end elseif cY then local function d2(F,C,aK)local cG=F+cS;local cH=C+cT;local cI=aK+cU;local cJ=cD*cG-cC*cI;cI=cC*cG+cD*cI;cG=cJ;local cK=cF*cH-cE*cG;cG=cE*cH+cF*cG;cH=cK;if cA~=0 then local cL=cA*cI-cB*cH;cH=cB*cI+cA*cH;cI=cL end;local cM=cI/cG*cw+cu;local cN=cH/cG*cx+cv;return cM,cN,cG,cH,cI end;local g,h,d0,d3,d4=d2(aC[1],aC[2],aC[3])local i,j,cJ,cK,cL=d2(aC[4],aC[5],aC[6])local a3,a4,d1,d5,d6=d2(aC[7],aC[8],aC[9])local d7=math.abs;local d8=d7(d1-0.0001)local d9=d7(d0-0.0001)local da=d9+d8;local db=(d6*d9+d4*d8)/da;local dc=(d5*d9+d3*d8)/da;local cu,cw,cv,cx=cu,cw,cv,cx;local dd=db*10000*cw+cu;local de=dc*10000*cx+cv;if aC[10]or(i-g)*(de-j)-(j-h)*(dd-i)<0 then cy:drawTriangle(g,h,i,j,dd,de,aC[11],aC[12],aC[13],aC[14],y)local df=d7(cJ-0.0001)local da=df+d8;local db=(cL*d8+d6*df)/da;local dc=(cK*d8+d5*df)/da;local dg=db*10000*cw+cu;local dh=dc*10000*cx+cv;cy:drawTriangle(dg,dh,i,j,dd,de,aC[11],aC[12],aC[13],aC[14],y)end end elseif cY then local function d2(F,C,aK)local cG=F+cS;local cH=C+cT;local cI=aK+cU;local cJ=cD*cG-cC*cI;cI=cC*cG+cD*cI;cG=cJ;local cK=cF*cH-cE*cG;cG=cE*cH+cF*cG;cH=cK;if cA~=0 then local cL=cA*cI-cB*cH;cH=cB*cI+cA*cH;cI=cL end;local cM=cI/cG*cw+cu;local cN=cH/cG*cx+cv;return cM,cN,cG,cH,cI end;local g,h,d0,d3,d4=d2(aC[1],aC[2],aC[3])local i,j,cJ,cK,cL=d2(aC[4],aC[5],aC[6])local a3,a4,d1,d5,d6=d2(aC[7],aC[8],aC[9])local d7=math.abs;if d1>0.00010000001 then local df=d7(cJ-0.0001)local d9=d7(d0-0.0001)local da=d9+df;local db=(cL*d9+d4*df)/da;local dc=(cK*d9+d3*df)/da;local cu,cw,cv,cx=cu,cw,cv,cx;local dd=db*10000*cw+cu;local de=dc*10000*cx+cv;if aC[10]or(dd-g)*(a4-de)-(de-h)*(a3-dd)<0 then cy:drawTriangle(g,h,dd,de,a3,a4,aC[11],aC[12],aC[13],aC[14],y)local d8=d7(d1-0.0001)local da=df+d8;local db=(cL*d8+d6*df)/da;local dc=(cK*d8+d5*df)/da;local dg=db*10000*cw+cu;local dh=dc*10000*cx+cv;cy:drawTriangle(dg,dh,dd,de,a3,a4,aC[11],aC[12],aC[13],aC[14],y)end else local d9=d7(d0-0.0001)local df=d7(cJ-0.0001)local d8=d7(d1-0.0001)local di=d9+df;local dj=d9+d8;local db=(d4*df+cL*d9)/di;local dc=(d3*df+cK*d9)/di;local cu,cw,cv,cx=cu,cw,cv,cx;local dd=db*10000*cw+cu;local de=dc*10000*cx+cv;local dk=(d4*d8+d6*d9)/dj;local dl=(d3*d8+d5*d9)/dj;local dg=dk*10000*cw+cu;local dh=dl*10000*cx+cv;if aC[10]or(dd-g)*(dh-de)-(de-h)*(dg-dd)<0 then cy:drawTriangle(g,h,dd,de,dg,dh,aC[11],aC[12],aC[13],aC[14],y)end end end elseif cY then local function d2(F,C,aK)local cG=F+cS;local cH=C+cT;local cI=aK+cU;local cJ=cD*cG-cC*cI;cI=cC*cG+cD*cI;cG=cJ;local cK=cF*cH-cE*cG;cG=cE*cH+cF*cG;cH=cK;if cA~=0 then local cL=cA*cI-cB*cH;cH=cB*cI+cA*cH;cI=cL end;local cM=cI/cG*cw+cu;local cN=cH/cG*cx+cv;return cM,cN,cG,cH,cI end;local g,h,d0,d3,d4=d2(aC[1],aC[2],aC[3])local i,j,cJ,cK,cL=d2(aC[4],aC[5],aC[6])local a3,a4,d1,d5,d6=d2(aC[7],aC[8],aC[9])local d7=math.abs;if cJ>0.00010000001 then if d1>0.00010000001 then local d9=d7(d0-0.0001)local df=d7(cJ-0.0001)local da=d9+df;local db=(d4*df+cL*d9)/da;local dc=(d3*df+cK*d9)/da;local cu,cw,cv,cx=cu,cw,cv,cx;local dd=db*10000*cw+cu;local de=dc*10000*cx+cv;if aC[10]or(i-dd)*(a4-j)-(j-de)*(a3-i)<0 then cy:drawTriangle(dd,de,i,j,a3,a4,aC[11],aC[12],aC[13],aC[14],y)local d8=d7(d1-0.0001)local da=d9+d8;local db=(d4*d8+d6*d9)/da;local dc=(d3*d8+d5*d9)/da;local dg=db*10000*cw+cu;local dh=dc*10000*cx+cv;cy:drawTriangle(dd,de,dg,dh,a3,a4,aC[11],aC[12],aC[13],aC[14],y)end else local d9=d7(d0-0.0001)local df=d7(cJ-0.0001)local d8=d7(d1-0.0001)local di=df+d9;local dj=df+d8;local db=(d4*df+cL*d9)/di;local dc=(d3*df+cK*d9)/di;local cu,cw,cv,cx=cu,cw,cv,cx;local dd=db*10000*cw+cu;local de=dc*10000*cx+cv;local dk=(cL*d8+d6*df)/dj;local dl=(cK*d8+d5*df)/dj;local dg=dk*10000*cw+cu;local dh=dl*10000*cx+cv;if aC[10]or(i-dd)*(dh-j)-(j-de)*(dg-i)<0 then cy:drawTriangle(dd,de,i,j,dg,dh,aC[11],aC[12],aC[13],aC[14],y)end end else if d1>0.00010000001 then local d9=d7(d0-0.0001)local df=d7(cJ-0.0001)local d8=d7(d1-0.0001)local di=d8+d9;local dj=d8+df;local db=(d4*d8+d6*d9)/di;local dc=(d3*d8+d5*d9)/di;local cu,cw,cv,cx=cu,cw,cv,cx;local dd=db*10000*cw+cu;local de=dc*10000*cx+cv;local dk=(cL*d8+d6*df)/dj;local dl=(cK*d8+d5*df)/dj;local dg=dk*10000*cw+cu;local dh=dl*10000*cx+cv;if aC[10]or(dg-dd)*(a4-dh)-(dh-de)*(a3-dg)<0 then cy:drawTriangle(dd,de,dg,dh,a3,a4,aC[11],aC[12],aC[13],aC[14],y)end end end end end end;function ct:drawObjects(dm)self.buffer:clearDepth()local av=self.camera;local cO={aH(av[4]or 0),aI(av[4]or 0),aH(-av[5]),aI(-av[5]),aH(av[6]),aI(av[6])}local dm=dm;for d=1,#dm do self:drawObject(dm[d],av,cO)end end;function ct:drawBuffer()local cy=self.buffer;cy:drawBuffer()cy:fastClear()end;function ct:setCamera(dn,dp,dq,aS,aT,aU)local aG=math.rad;if type(dn)=="table"then local av=dn;self.camera={av.x or self.camera[1]or 0,av.y or self.camera[2]or 0,av.z or self.camera[3]or 0,av.rotX and aG(av.rotX+90)or self.camera[4]or 0,av.rotY and aG(av.rotY)or self.camera[5]or 0,av.rotZ and aG(av.rotZ)or self.camera[6]or 0,self.camera[7]}else self.camera={dn or self.camera[1]or 0,dp or self.camera[2]or 0,dq or self.camera[3]or 0,aS and aG(aS+90)or self.camera[4]or 0,aT and aG(aT)or self.camera[5]or 0,aU and aG(aU)or self.camera[6]or 0,self.camera[7]}end;if self.camera[4]==math.pi*0.5 then self.camera[4]=nil end end;function ct:setFoV(cV)self.FoV=cV or 90;self.t=cq(aG(self.FoV/2))*2*0.0001;cz()self.camera[7]=aG(self.FoV)end;function ct:setWireFrame(ap)self.buffer:useTriangleEdges(ap)end;function ct:getObjectIndexTrace(dm,F,C)local function dr(g,h,i,j,a3,a4)return(g-a3)*(j-a4)-(i-a3)*(h-a4)end;local function ds(dt,du,g,h,i,j,a3,a4,dv,dw,dx,dy)local af=dr(dt,du,g,h,i,j)<0;local ah=dr(dt,du,i,j,a3,a4)<0;local aj=dr(dt,du,a3,a4,g,h)<0;return af==ah and ah==aj end;local C=C-1;local dz=self.blittleOn;local dA=self.x1;local dB=self.y1;local dC=self.x2;local dD=self.y2;if dz then F=F*2;C=C*3+1 end;local av=self.camera;local cO={aH(av[4]or 0),aI(av[4]or 0),aH(-av[5]),aI(-av[5]),aH(av[6]),aI(av[6])}local cA=cO[1]local cB=cO[2]local cC=cO[3]local cD=cO[4]local cE=cO[5]local cF=cO[6]local dE={}for d=1,#dm do local ca=dm[d]local aR=ca[7]local aS=ca[4]local aT=ca[5]local aU=ca[6]if aS and aS~=0 or aT and aT~=0 or aU and aU~=0 then aR=aQ(aR,aS,aT,aU)end;local cP=ca[1]local cQ=ca[2]local cR=ca[3]local cu=cu;local cv=cv;local cw=cw;local cx=cx;local cA=cA;local cB=cB;local cC=cC;local cD=cD;local cE=cE;local cF=cF;local cS=cP-av[1]local cT=cQ-av[2]local cU=cR-av[3]local function cZ(F,C,aK)local cG=F+cS;local cH=C+cT;local cI=aK+cU;local cJ=cD*cG-cC*cI;cI=cC*cG+cD*cI;cG=cJ;local cK=cF*cH-cE*cG;cG=cE*cH+cF*cG;cH=cK;if cA~=0 then local cL=cA*cI-cB*cH;cH=cB*cI+cA*cH;cI=cL end;local cM=cI/cG*cw+cu;local cN=cH/cG*cx+cv;return cM,cN,cG>0 end;for c6=1,#aR do local aC=aR[c6]local g,h,dF=cZ(aC[1],aC[2],aC[3])if dF then local i,j,dG=cZ(aC[4],aC[5],aC[6])if dG then local a3,a4,dH=cZ(aC[7],aC[8],aC[9])if dH then if aC[10]or(i-g)*(a4-j)-(j-h)*(a3-i)<0 then local aD=cS+(aC[1]+aC[4]+aC[7])/3;local aE=cT+(aC[2]+aC[5]+aC[8])/3;local aF=cU+(aC[3]+aC[6]+aC[9])/3;local y=aD*aD+aE*aE+aF*aF;if not dz then if ds(F,C,g,h,i,j,a3,a4,dA,dB,dC,dD)then dE[#dE+1]={objectIndex=d,polygonIndex=c6,depth=y}end else if ds(F,C,g,h,i,j,a3,a4,(dC-1)*2+1,(dB-1)*3+1,dC*2,(dD+1)*3)then dE[#dE+1]={objectIndex=d,polygonIndex=c6,depth=y}end end end end end end end end;if#dE<=0 then return elseif#dE==1 then return dE[1].objectIndex,dE[1].polygonIndex,dE[1].depth end;local dI=-1;local dJ=math.huge;for d=1,#dE do local dK=dE[d]if dK.depth<dJ then dJ=dK.depth;dI=d end end;local dK=dE[dI]return dK.objectIndex,dK.polygonIndex,dK.depth end;function ct:newObject(aR,F,C,aK,aS,aT,aU)local bV=nil;local bW=nil;if type(aR)=="table"then if aR.initObject then else bV,bW=bS(aR)end else local dL=bR(aR)bV,bW=bS(dL)end;local ca={F,C,aK,aS,aT,aU,bV,bW}ca.frame=self;function ca:setPos(dM,dN,dO)self[1]=dM or self[1]self[2]=dN or self[2]self[3]=dO or self[3]end;function ca:setRot(dP,dQ,dR)self[4]=dP or self[4]self[5]=dQ or self[5]self[6]=dR or self[6]end;function ca:setModel(dS)if type(dS)=="table"then bV,bW=bS(dS)self[7]=bV;self[8]=bW else local dL=bR(dS)bV,bW=bS(dL)self[7]=bV;self[8]=bW end end;if type(aR)=="table"then if aR.initObject then aR:initObject(ca)end end;return ca end;cz()ct:highResMode(true)return ct end;local dT={}local function dU(g,h,b2,i,j,aN,a3,a4,b3,L)local bb={x1=g,y1=h,z1=b2,x2=i,y2=j,z2=aN,x3=a3,y3=a4,z3=b3,c=L}return bb end;function dT:cube(dV)dV.color=dV.color or colors.red;local dW={dU(-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,dV.bottom or dV.color),dU(-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,dV.bottom2 or dV.bottom or dV.color),dU(-.5,.5,-.5,-.5,.5,.5,.5,.5,.5,dV.top or dV.color),dU(-.5,.5,-.5,.5,.5,.5,.5,.5,-.5,dV.top or dV.color),dU(-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,dV.side or dV.color),dU(-.5,-.5,.5,-.5,.5,.5,-.5,.5,-.5,dV.side2 or dV.side or dV.color),dU(.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,dV.side or dV.color),dU(.5,-.5,-.5,.5,.5,-.5,.5,.5,.5,dV.side2 or dV.side or dV.color),dU(-.5,-.5,-.5,.5,.5,-.5,.5,-.5,-.5,dV.side or dV.color),dU(-.5,-.5,-.5,-.5,.5,-.5,.5,.5,-.5,dV.side2 or dV.side or dV.color),dU(-.5,-.5,.5,.5,-.5,.5,-.5,.5,.5,dV.side or dV.color),dU(.5,-.5,.5,.5,.5,.5,-.5,.5,.5,dV.side2 or dV.side or dV.color)}for bP,bQ in pairs(b4)do dW[bP]=bQ end;return dW end;function dT:sphere(dV)dV.res=dV.res or 32;dV.color=dV.color or colors.red;local aR={}local dX={}for d=0,dV.res do local C=0.5*aI(d/dV.res*cp)local dY={}for c6=0,dV.res do local dZ=0.5*cg(1-C*2*C*2)local F=aI(c6/dV.res*cp*2)*dZ;local aK=aH(c6/dV.res*cp*2)*dZ;local i=aI((c6+1)/dV.res*cp*2)*dZ;local aN=aH((c6+1)/dV.res*cp*2)*dZ;if dX[c6]then aR[#aR+1]={x1=dX[(c6+1)%dV.res].x,y1=dX[(c6+1)%dV.res].y,z1=dX[(c6+1)%dV.res].z,x2=F,y2=C,z2=aK,x3=dX[c6].x,y3=dX[c6].y,z3=dX[c6].z,c=dV.color}aR[#aR+1]={x1=i,y1=C,z1=aN,x2=F,y2=C,z2=aK,x3=dX[(c6+1)%dV.res].x,y3=dX[(c6+1)%dV.res].y,z3=dX[(c6+1)%dV.res].z,c=dV.color2 or dV.color}end;dY[c6]={x=F,y=C,z=aK}end;dX=dY end;if dV.colors or dV.top or dV.bottom then for d=1,#aR do local bb=aR[d]local aE=(bb.y1+bb.y2+bb.y3)/3;if dV.colors then local d_=o((-aE+0.5)*#dV.colors+1)bb.c=dV.colors[d_]or bb.c else if aE>=0 then bb.c=dV.top or bb.c else bb.c=dV.bottom or bb.c end end end end;for bP,bQ in pairs(b4)do aR[bP]=bQ end;return aR end;function dT:icosphere(dV)dV.res=dV.res or 1;local e0=(1+cg(5))/2;local e1={{e0,1,0},{e0,-1,0},{-e0,-1,0},{-e0,1,0},{1,0,e0},{-1,0,e0},{-1,0,-e0},{1,0,-e0},{0,e0,1},{0,e0,-1},{0,-e0,-1},{0,-e0,1}}local function e2(bo,bp,bq)return dU(e1[bo][1],e1[bo][2],e1[bo][3],e1[bp][1],e1[bp][2],e1[bp][3],e1[bq][1],e1[bq][2],e1[bq][3],dV.colors and 1 or dV.color)end;local aR={e2(11,2,12),e2(11,8,2),e2(11,7,8),e2(11,3,7),e2(11,12,3),e2(4,7,3),e2(4,10,7),e2(4,9,10),e2(4,6,9),e2(4,3,6),e2(5,6,12),e2(5,9,6),e2(5,1,9),e2(5,2,1),e2(5,12,2),e2(3,12,6),e2(1,8,10),e2(1,10,9),e2(1,2,8),e2(10,8,7)}local function e3()local bN={}for d=1,#aR do local bb=aR[d]local e4={x=(bb.x1+bb.x2)/2,y=(bb.y1+bb.y2)/2,z=(bb.z1+bb.z2)/2}local e5={x=(bb.x1+bb.x3)/2,y=(bb.y1+bb.y3)/2,z=(bb.z1+bb.z3)/2}local e6={x=(bb.x2+bb.x3)/2,y=(bb.y2+bb.y3)/2,z=(bb.z2+bb.z3)/2}local e7=bb.c;if dV.colorsFractal then e7=e7%#dV.colors+1 end;bN[#bN+1]=dU(e4.x,e4.y,e4.z,e6.x,e6.y,e6.z,e5.x,e5.y,e5.z,bb.c)bN[#bN+1]=dU(bb.x1,bb.y1,bb.z1,e4.x,e4.y,e4.z,e5.x,e5.y,e5.z,e7)bN[#bN+1]=dU(e4.x,e4.y,e4.z,bb.x2,bb.y2,bb.z2,e6.x,e6.y,e6.z,e7)bN[#bN+1]=dU(e5.x,e5.y,e5.z,e6.x,e6.y,e6.z,bb.x3,bb.y3,bb.z3,e7)end;aR=bN end;for d=1,dV.res-1 do e3()end;local function e8(F,C,aK)local e9=math.sqrt(F*F+C*C+aK*aK)local ea=0.5/e9;return F*ea,C*ea,aK*ea end;for d=1,#aR do local bb=aR[d]bb.x1,bb.y1,bb.z1=e8(bb.x1,bb.y1,bb.z1)bb.x2,bb.y2,bb.z2=e8(bb.x2,bb.y2,bb.z2)bb.x3,bb.y3,bb.z3=e8(bb.x3,bb.y3,bb.z3)if not dV.colorsFractal then local aE=(bb.y1+bb.y2+bb.y3)/3;if dV.colors then local d_=math.floor((-aE+0.5)*#dV.colors+1)bb.c=dV.colors[d_]or bb.c else if aE>=0 then bb.c=dV.top or bb.c else bb.c=dV.bottom or bb.c end end else bb.c=dV.colors[bb.c]end end;for bP,bQ in pairs(b4)do aR[bP]=bQ end;return aR end;function dT:plane(dV)dV.color=dV.color or colors.lime;dV.size=dV.size or 1;dV.y=dV.y or 0;local eb={dU(-1*dV.size,dV.y,1*dV.size,1*dV.size,dV.y,-1*dV.size,-1*dV.size,dV.y,-1*dV.size,dV.color),dU(-1*dV.size,dV.y,1*dV.size,1*dV.size,dV.y,1*dV.size,1*dV.size,dV.y,-1*dV.size,dV.color)}for bP,bQ in pairs(b4)do eb[bP]=bQ end;return eb end;function dT:mountains(dV)dV.res=dV.res or 20;dV.randomOffset=dV.randomOffset or 0;dV.height=dV.height or 1;dV.randomHeight=dV.randomHeight or 0;dV.y=dV.y or 0;dV.scale=dV.scale or 100;dV.color=dV.color or colors.green;dV.snowColor=dV.snowColor or colors.white;local ec=3/dV.res*dV.height/(dV.randomHeight+1)local ed=3/dV.res*dV.height*(dV.randomHeight+1)local aR={}for d=0,dV.res do local ee=math.random(-dV.randomOffset*100,dV.randomOffset*100)/100;local ef=d+ee;local g=aI((ef-1)/dV.res*cp*2)*dV.scale;local b2=aH((ef-1)/dV.res*cp*2)*dV.scale;local i=aI((ef-0.5)/dV.res*cp*2)*dV.scale;local aN=aH((ef-0.5)/dV.res*cp*2)*dV.scale;local a3=aI(ef/dV.res*cp*2)*dV.scale;local b3=aH(ef/dV.res*cp*2)*dV.scale;local eg=math.random(ec*100,ed*100)/100*dV.scale;local aC={x1=g,y1=dV.y,z1=b2,x2=a3,y2=dV.y,z2=b3,x3=i,y3=dV.y+eg,z3=aN,c=dV.color,forceRender=true}aR[#aR+1]=aC;if dV.snow then local eh=0.93;local ei=dV.snowHeight or 0.5;local ej=1-ei*ed/(eg/dV.scale)ej=n(0,m(1,ej))if ej>0.2 then local ek={x1=(g*ej+i*(1-ej))*eh,y1=dV.y+eg*(1-ej),z1=(b2*ej+aN*(1-ej))*eh,x2=(a3*ej+i*(1-ej))*eh,y2=dV.y+eg*(1-ej),z2=(b3*ej+aN*(1-ej))*eh,x3=i*eh,y3=dV.y+eg,z3=aN*eh,c=dV.snowColor,forceRender=true}aR[#aR+1]=ek end end end;for bP,bQ in pairs(b4)do aR[bP]=bQ end;return aR end;return{newFrame=cr,loadModel=bR,newBuffer=q,linear=f,models=dT,transforms=b4}